---
title: "REINVENT 3.7 Figures"
author: "Chris & Octavio"
date: "May 8, 2020"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: false
    code_folding: hide
    fig_width: 7
    fig_height: 4
    fig_caption: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r RestartEnvironment, echo = FALSE}
#.rs.restartR()
rm(list=ls())
graphics.off()
cat("\014")
```

```{r Libraries, echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(broom)
library(knitr)
library(reshape2)
library(pander)

#library(Hmisc)
library(corrplot)
library(CCA)
library(GGally)
#library(export)
```

```{r InitialSetup}
# Set working directory
#setwd("G:/My Drive/NPNL/Papers/2020")

# Figure Properties
fnt  <- 12
sz <- 10

# Colors
catColor <- c("#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666")

# Color-blind safe colors
divColor <- c("#a6611a","#dfc27d","#80cdc1","#018571")
seqColor <- c("#a6611a","#dfc27d","#80cdc1","#018571")

divColor2 <- c("#01665e","#35978f","#80cdc1","#c7eae5","#f6e8c3","#dfc27d","#bf812d","#8c510a","#80cdc1")
seqColor2 <- c("#0c2c84","#225ea8","#1d91c0","#41b6c4","#7fcdbb","#c7e9b4","#edf8b1","#ffffd9")


figTheme <- theme(#legend.position="none",
  legend.text = element_text(size = fnt),
  legend.title = element_text(size = fnt),
  plot.title = element_text(size = fnt),
  strip.text.x = element_text(size = fnt),
  axis.title.x = element_text(size = fnt),
  axis.title.y = element_text(size = fnt),
  axis.text.x = element_text(size = fnt),
  axis.text.y = element_text(size = fnt))

# Functions
b_fun <- function(mod){
  modsum <- summary(mod)
  return(modsum$coefficients[[2,"Estimate"]])
}

p_fun <- function(mod){
  modsum <- summary(mod)
  return(modsum$coefficients[[2,"Pr(>|t|)"]])
}

t_fun <- function(data){
  t.test(behav.pre$FMA, behav.post$FMA, paired = TRUE)
}

emb_fun <- function(var){
  var = case_when(
    var == 1 ~ -3,
    var == 2 ~ -2,
    var == 3 ~ -1,
    var == 4 ~ 0,
    var == 5 ~ 1,
    var == 6 ~ 2,
    var == 7 ~ 3)
  return(var)
}

# Data frames
load("rvtFigData.Rda")
```

***

# Table 1 Demographics
```{r Demographics}
demograph.data <- 
  quest.data$demographics %>%
  select(-c(Date.of.birth,Date.of.stroke,Date.of.appointment,Previously.used.HMD))

demograph.data$FMA <-
  behav.data %>%
  filter(session == 1) %>%
  select(FMA)


demograph.data%>%
  dplyr::rename(
    "Participant" = Subject,
    "Sex" = Gender,
    "Stroke Onset (months)" = Months.since.stroke,
    "FMA-UE" = FMA,
    "Paresis" = Affected.side) %>%
  pander()
```


***

# Feasibility

## Simulator Sickness
```{r Quest_SimulatorSickness, eval = FALSE}
# SElect fields
quest.simsick <- quest.data$simulatorSickness %>%
  select(subject,session,time,nausea,oculomotor,disorientation) %>%
  mutate(total = (nausea + oculomotor + disorientation)*100/63)
names(quest.simsick) <- c("subject","session","time","Nausea","Oculomotor","Disorientation","Sickness")

quest.simsick %>%
  filter(time == "Post") %>%
  # Reshape data
  select(subject,session,Nausea,Oculomotor,Disorientation) %>%
  mutate(session = ifelse(session == 0,"Pre","Post")) %>%
  melt(id = c("subject","session")) %>%
  ggplot() +
  
  geom_line(aes(as.factor(session), value, group = as.factor(subject), color = as.factor(subject)), size = sz-2, alpha = 0.7) +
  geom_point(aes(as.factor(session), value, shape = as.factor(subject), fill = as.factor(subject)),size = sz-1) +
  
  facet_wrap(~variable, ncol = 5, scales = "free") +
  xlab("Evaluation") +
  ylab("Raw score (Out of 20 pts)") +
  theme_classic() +
  scale_x_discrete(limits = c("Pre","Post")) +
  scale_y_continuous(limits = c(0,20)) +
  scale_color_manual(values = seqColor[1:5]) +
  scale_fill_manual(values = seqColor[1:5]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  labs(
    title = "Simulator Sickness Components - Session 1 vs Session 7",
    fill = "Participant",
    shape = "Participant",
    color = "Participant"
  )

quest.simsick %>%
  filter(time == "Post") %>%
  mutate(session = ifelse(session == 0,"Pre","Post")) %>%
  
  ggplot() +
  geom_line(aes(as.factor(session), Sickness, group = as.factor(subject), color = as.factor(subject)), size = 5, alpha = 0.7) +
  geom_point(aes(as.factor(session), Sickness, shape = as.factor(subject), fill = as.factor(subject)),size = 6) +
  
  #facet_wrap(~variable, ncol = 5, scales = "free") +
  xlab("Evaluation") +
  ylab("Sickness %") +
  theme_classic() +
  scale_x_discrete(limits = c("Pre","Post")) +
  scale_y_continuous(limits = c(0,20)) +
  scale_color_manual(values = seqColor[1:5]) +
  scale_fill_manual(values = seqColor[1:5]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  labs(
    title = "Overall Sickness - Session 1 vs Session 7",
    fill = "Participant",
    shape = "Participant",
    color = "Participant"
  )

```

Group stats on Simulator sickness
```{r, eval=F}
pre <- quest.simsick %>%
  filter(time == "Post") %>%
  filter(session == 0)
post <- quest.simsick %>%
  filter(time == "Post") %>%
  filter(session == 7)

t.test(pre$Sickness, post$Sickness, paired = TRUE)
```

## Experience

* 3/4 found the environment interesting
* They liked: the beach, the experience, the people.
* Didn't like: the umbrella, couldn't see the kids.
* Nobody felt distracted by the objects in the beach.
* Strategies used:
+ Send all my energy to the wrist
+ Concentrate at the tip of my fingers. Imagine the movement
+ Squeeze the muscles
* Everyone enjoyed the experience
* All are likely to use the device again
* Suggestions: ability to adjust the speed (adjustable settings), add more tasks, real people in VR (social interaction), play volleyball





***


# Fig 2 Clinical Assessments

```{r Behavior, message = FALSE, warning = FALSE}
# Group stats
scaleName = c("FMA","ARAT","Extension", "Flexion", "Ulnar Dev.", "Radial Dev.",
              "Grip Less-Imp.", "Grip More-Imp.", "SIS-16")

aux = TRUE
for (scale in c("FMA","ARAT","WE","WF","UD","RD","GripLess","GripMore","SIS16")) {
  
  pre <-
    behav.data %>%
    filter(session == 1) %>%
    pull(scale)
  post <-
    behav.data %>%
    filter(session == 10) %>%
    pull(scale)
  
  tt <- t.test(pre, post, paired = TRUE)
  
  if(aux){
    t <- data.frame(Assessment = scale, t = tt$statistic, p = tt$p.value,
                    Pre = paste(mean(pre, na.rm = T)," (",formatC(sd(pre, na.rm = T),digits = 5),")",sep = ""),
                    Post = paste(mean(post, na.rm = T)," (",formatC(sd(post, na.rm = T),digits = 5),")",sep = ""))
    aux = FALSE
  }
  else{
    t <- bind_rows(t,data.frame(Assessment = scale, t = tt$statistic, p = tt$p.value,
                                Pre = paste(mean(pre, na.rm = T)," (",formatC(sd(pre, na.rm = T),digits = 5),")",sep = ""),
                                Post = paste(mean(post, na.rm = T)," (",formatC(sd(post, na.rm = T),digits = 5),")",sep = "")))
  }
}

t$Assessment <- scaleName

t %>%
  arrange(Assessment) %>%
  pander()


# Change session to Pre-Post
behav.melt <- behav.data %>%
  filter(session %in% c(1,10)) %>%
  mutate(session = ifelse(session == 1, "Pre","Post")) %>%
  dplyr::rename(
    "Ulnar Dev." = UD,
    "Radial Dev." = RD,
    "Flexion" = WF,
    "Extension" = WE,
    "SIS-16" = SIS16) %>%
  #select(c(subject,session,FMA,ARAT,SIS16)) %>%
  melt(id = c("subject","session"))

# Plot FMA and ARAT
behav.melt %>%
  ggplot() +
  geom_line(aes(session, value, group = as.factor(subject), color = as.factor(subject)), size = 2, alpha = 0.7, show.legend = F) +
  geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)), size = 3) +
  
  facet_wrap(~ variable, scales = "free", ncol = 5) +
  xlab("Evaluation") +
  ylab("") +
  theme_classic() +
  scale_x_discrete(limits = c("Pre","Post")) +
  scale_color_manual(values = seqColor[1:5]) +
  scale_fill_manual(values = seqColor[1:5]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  theme( strip.background.x = element_blank())+
  labs(
    title = "Clinical Assessments",
    #subtitle = "Pre and post evaluation",
    #caption = "REINVENT Group 3",
    fill = "Participant",
    shape = "Participant",
    color = ""
  )
ggsave("svg/behav.svg", device = "svg", 
       width = 8,  height = 6,  units = "in",  dpi = 300)

```

***

## Tracking Performance
```{r TrackingError}
# behav.melt <- behav.data %>%
#   filter(session %in% c(1,10)) %>%
#   filter(subject <= subNum) %>%
#   mutate(session = ifelse(session == 1, "Pre","Post")) %>%
#   select(c(subject,session,FMA,ARAT,SIS16)) %>%
#   melt(id = c("subject","session"))

# Plot Tracking
track.data %>%
  dplyr::rename("subject" = participant) %>%
  #filter(metric == "error") %>%
  ggplot() +
  geom_line(aes(session, value, group = as.factor(subject), color = as.factor(subject)), size = 2, alpha = 0.7, show.legend = F) +
  geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)),size = 3) +
  
  facet_wrap(metric ~ task, scales = "free_x", ncol = 2) +
  xlab("Evaluation") +
  ylab("") +
  theme_classic() +
  scale_x_discrete(limits = c("Pre","Post")) +
  scale_y_continuous(limits = c(0,6)) +
  scale_color_manual(values = seqColor[1:5]) +
  scale_fill_manual(values = seqColor[1:5]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  labs(
    title = "Behavior Assessments",
    #subtitle = "Pre and post evaluation",
    #caption = "REINVENT Group 3",
    fill = "Participant",
    shape = "Participant",
    color = ""
  )
ggsave("svg/tracking.svg", device = "svg", 
       width = 4,  height = 6,  units = "in",  dpi = 300)

# Individual stats
track.data %>%
  filter(session == "Post",metric == "Error") %>%
  select(-c(session,metric,value)) %>%
  pander()

# Group t-test
aux = TRUE
for (mt in c("Error","Deviation")) {
  for (tk in c("Extension","Flexion")) {
    pre <- track.data %>%
      filter(session == "Pre",metric == mt, task == tk) %>%
      pull(value)
    post <- track.data %>%
      filter(session == "Post",metric == mt, task == tk) %>%
      pull(value)
    
    tt <- t.test(pre, post, paired = TRUE)
    
    if(aux){
      t <- data.frame(task = paste(tk,mt,sep = " "), t = tt$statistic, p = tt$p.value,
                      Pre = paste(mean(pre, na.rm = T)," (",formatC(sd(pre, na.rm = T),digits = 5),")",sep = ""),
                      Post = paste(mean(post, na.rm = T)," (",formatC(sd(post, na.rm = T),digits = 5),")",sep = ""))
      aux = FALSE
    }
    else{
      t <- bind_rows(t,data.frame(task = paste(tk,mt,sep = " "), t = tt$statistic, p = tt$p.value,
                                  Pre = paste(mean(pre, na.rm = T)," (",formatC(sd(pre, na.rm = T),digits = 5),")",sep = ""),
                                  Post = paste(mean(post, na.rm = T)," (",formatC(sd(post, na.rm = T),digits = 5),")",sep = "")))
    }
  }
}

t %>%
  dplyr::rename("Task" = task) %>%
  pander()


```

```{r TrackError2}
track.data %>%
  dplyr::rename("subject" = participant) %>%
  #filter(metric == "error") %>%
  ggplot() +
  #geom_line(aes(session, value, group = as.factor(subject), color = as.factor(subject)), size = 2, alpha = 0.7, show.legend = F) +
  #geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)),size = 3) +
  geom_boxplot(aes(session, value)) +
  geom_dotplot(aes(session, value, fill = as.factor(subject)), binaxis = "y", stackdir = "center", dotsize = 2) +
  
  facet_wrap(metric ~ task, scales = "free_x", ncol = 2) +
  xlab("Evaluation") +
  ylab("") +
  theme_classic() +
  scale_x_discrete(limits = c("Pre","Post")) +
  scale_y_continuous(limits = c(0,6)) +
  scale_color_manual(values = seqColor[1:5]) +
  scale_fill_manual(values = seqColor[1:5]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  labs(
    title = "Behavior Assessments",
    #subtitle = "Pre and post evaluation",
    #caption = "REINVENT Group 3",
    fill = "Participant",
    shape = "Participant",
    color = ""
  )
ggsave("svg/tracking2.svg", device = "svg", 
       width = 4,  height = 6,  units = "in",  dpi = 300)

track.data %>%
  dplyr::rename("subject" = participant) %>%
  #filter(metric == "error") %>%
  ggplot() +
  
  #geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)),size = 3) +
  geom_boxplot(aes(session, value, fill = as.factor(task))) +
  geom_line(aes(session, value, group = as.factor(subject), color = as.factor(subject)), size = 2, alpha = 0.7, show.legend = F) +
  geom_dotplot(aes(session, value, fill = as.factor(subject)), binaxis = "y", stackdir = "center", dotsize = 1) +
  
  facet_wrap(metric ~ task, scales = "free_x", ncol = 2) +
  xlab("Evaluation") +
  ylab("") +
  theme_classic() +
  scale_x_discrete(limits = c("Pre","Post")) +
  scale_y_continuous(limits = c(0,6)) +
  #scale_color_manual(values = divColor[1:5]) +
  #scale_fill_manual(values = divColor[1:5]) +
  #scale_shape_manual(values = 21:24) +
  figTheme +
  theme( strip.background.x = element_blank())+
  labs(
    title = "Tracking Error",
    #subtitle = "Pre and post evaluation",
    #caption = "REINVENT Group 3",
    fill = "Legend",
    shape = "",
    color = ""
  )
ggsave("svg/tracking3.svg", device = "svg", 
       width = 4,  height = 6,  units = "in",  dpi = 300)


```


```{r}
track.data %>%
  dplyr::rename("subject" = participant) %>%
  #filter(metric == "error") %>%
  ggplot() +
  
  geom_boxplot(aes(session, value)) +
  geom_line(aes(session, value, group = as.factor(subject), color = as.factor(subject)), size = 2, alpha = 0.7, show.legend = F) +
  geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)),size = 2) +
  
  facet_wrap(metric ~ task, scales = "free_x", ncol = 2, strip.position = "left") +
  xlab("Evaluation") +
  ylab("") +
  theme_classic() +
  scale_x_discrete(limits = c("Pre","Post")) +
  scale_y_continuous(limits = c(0,6)) +
  scale_color_manual(values = seqColor[1:4]) +
  scale_fill_manual(values = seqColor[1:4]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  theme( strip.background.y = element_blank())+
  labs(
    title = "Tracking Error",
    #subtitle = "Pre and post evaluation",
    #caption = "REINVENT Group 3",
    fill = "Participant",
    shape = "Participant",
    color = ""
  )
ggsave("svg/tracking4.svg", device = "svg", 
       width = 6,  height = 6,  units = "in",  dpi = 300)



track.data %>%
  dplyr::rename("subject" = participant) %>%
  #filter(task == "Extension") %>%
  ggplot() +
  
  #geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)),size = 3) +
  # geom_boxplot(aes(session, value)) +
  # geom_line(aes(session, value, group = as.factor(subject), color = as.factor(subject)), size = 2, alpha = 0.7, show.legend = F) +
  #  geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)),size = 2) +
  geom_bar(aes(session,value, fill = task ), stat = "identity", position = "dodge") +
  
  facet_wrap(metric ~ subject, scales = "free_x", ncol = 4, strip.position = "left") +
  xlab("Evaluation") +
  ylab("") +
  theme_classic() +
  scale_x_discrete(limits = c("Pre","Post")) +
  #scale_y_continuous(limits = c(0,6)) +
  scale_color_manual(values = divColor[1:4]) +
  scale_fill_manual(values = divColor[1:4]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  theme( strip.background.y = element_blank())+
  labs(
    title = "Tracking Error",
    #subtitle = "Pre and post evaluation",
    #caption = "REINVENT Group 3",
    fill = "Task",
    shape = "",
    color = ""
  )
ggsave("svg/tracking5.svg", device = "svg", 
       width = 6,  height = 5,  units = "in",  dpi = 300)


track.data %>%
  dplyr::rename("subject" = participant) %>%
  filter(metric == "Error") %>%
  ggplot() +
  
  #geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)),size = 3) +
  # geom_boxplot(aes(session, value)) +
  # geom_line(aes(session, value, group = as.factor(subject), color = as.factor(subject)), size = 2, alpha = 0.7, show.legend = F) +
  #  geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)),size = 2) +
  geom_bar(aes(session,value, fill = task ), stat = "identity", position = "dodge") +
  
  facet_wrap(task ~ subject, scales = "free_x", ncol = 4, strip.position = "left") +
  xlab("Evaluation") +
  ylab("") +
  theme_classic() +
  scale_x_discrete(limits = c("Pre","Post")) +
  #scale_y_continuous(limits = c(0,6)) +
  scale_color_manual(values = divColor[1:4]) +
  scale_fill_manual(values = divColor[1:4]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  theme( strip.background.y = element_blank(),
         legend.text = element_blank())+
  labs(
    title = "Tracking Error",
    #subtitle = "Pre and post evaluation",
    #caption = "REINVENT Group 3",
    fill = "",
    shape = "",
    color = ""
  )
ggsave("svg/tracking6.svg", device = "svg", 
       width = 6,  height = 5,  units = "in",  dpi = 300)


track.error <-
  track.data %>%
  filter(metric == "Error") %>%
  select(-c(metric,p)) %>%
  dplyr::rename("error" = value, "subject" = participant)
track.dev <-
  track.data %>%
  filter(metric == "Deviation")

track.error$lowSD <- track.error$error-track.dev$value
track.error$upSD <- track.error$error+track.dev$value

track.error %>%
  
  #filter(task == "Flexion") %>%
  ggplot() +
  
  #geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)),size = 3) +
  # geom_boxplot(aes(session, value)) +
  # geom_line(aes(session, value, group = as.factor(subject), color = as.factor(subject)), size = 2, alpha = 0.7, show.legend = F) +
  #  geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)),size = 2) +
  geom_bar(aes(session,error, fill = as.factor(subject) ), stat = "identity", position = "dodge") +
  geom_errorbar(aes(session,error,ymin = lowSD, ymax = upSD)) +
  
  facet_wrap(task ~ subject, scales = "free_x", ncol = 4, strip.position = "left") +
  xlab("Evaluation") +
  ylab("") +
  theme_classic() +
  scale_x_discrete(limits = c("Pre","Post")) +
  #scale_y_continuous(limits = c(0,6)) +
  scale_color_manual(values = divColor[1:4]) +
  scale_fill_manual(values = divColor[1:4]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  theme( strip.background.y = element_blank(),
         legend.text = element_blank())+
  labs(
    title = "Tracking Error",
    #subtitle = "Pre and post evaluation",
    #caption = "REINVENT Group 3",
    fill = "",
    shape = "",
    color = ""
  )
ggsave("svg/tracking7.svg", device = "svg", 
       width = 6,  height = 5,  units = "in",  dpi = 300)


```


***




# Fig 5 Reinvent Training

## A Session Performance
# Success Rate
```{r RVTperformance}
rvt.block <- 
  rvt.data %>%
  filter(session > 2) %>%
  mutate(session = session-2) %>%
  mutate(allBlock = block + (session-1)*6) %>%
  filter(state == "active")

perf.block <-
  rvt.block %>%  
  filter(group == "ext") %>%
  group_by(subject,allBlock) %>%
  summarise(score = sum(successCalc)/20*100)

perf.sess <-
  rvt.block %>%  
  filter(group == "ext") %>%
  group_by(subject,session) %>%
  summarise(score = sum(successCalc)/120*100)
  #summarise(score = sum(success))


# perf.block %>%
# ggplot() +
#   geom_point(aes(allBlock, score, fill = as.factor(subject)), shape = 21, size = sz-5) +
#   geom_smooth(method = 'lm', aes(allBlock, score)) + 
#   
#   facet_wrap( ~ subject, ncol = 4) +
#   xlab("Block") +
#   ylab("Success %") +
#   theme_classic() +
#   scale_x_discrete(limits = seq(0,40,10)) +
#   scale_y_continuous(limits = c(0,100)) +
#   scale_color_manual(values = seqColor[c(1:4)]) +
#   scale_fill_manual(values = seqColor[c(1:4)]) +
#   figTheme +
#   labs(
#     title = "Block Performance",
#     fill = "Subject"
#   )

perf.sess %>%
  ggplot() +
  geom_point(aes(session, score, fill = as.factor(subject)), shape = 21, size = 2) +
  #geom_smooth(method = 'lm', aes(session, score)) + 
  
  facet_wrap( ~ subject, ncol = 4) +
  xlab("Session") +
  ylab("Success %") +
  theme_classic() +
  scale_x_discrete(limits = seq(1,7,2)) +
  scale_y_continuous(limits = c(0,100)) +
  scale_color_manual(values = seqColor[c(1:4)]) +
  scale_fill_manual(values = seqColor[c(1:4)]) +
  figTheme +
  labs(
    title = "Sesison Performance",
    fill = "Participant"
  )
```

```{r ScoreCorrelation, warning = FALSE}
# Block Correlation
perf.nestBlock <-
  perf.block %>%
  as_tibble() %>%
  group_by(subject) %>%
  nest()

print("Block correlation")
perf.nestBlock %>%
  mutate(
    test = map(data, ~cor.test(.x$allBlock, .x$score, method = "spearman")),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  select(c("subject", "estimate","p.value")) %>%
  dplyr::rename("Participant"=subject, "rho"=estimate, "p"=p.value)%>%
  pander()

# Session correlation
perf.nestSess <-
  perf.sess %>%
  as_tibble() %>%
  group_by(subject) %>%
  nest()

print("Session correlation")
perf.nestSess %>%
  mutate(
    test = map(data, ~cor.test(.x$session, .x$score, method = "spearman")),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  select(c("subject", "estimate","p.value")) %>%
  dplyr::rename("Participant"=subject, "rho"=estimate, "p"=p.value)%>%
  pander()
```


## A Session Threshold

## Threshold change

```{r Threshold}
thresh.sess <-
  rvt.block %>%  
  filter(group == "ext") %>%
  group_by(subject,session) %>%
  summarise(avg = mean(threshold)*100)

thresh.sess$avg[1:7] <- c(29,29,55,62,38,47,13)

thresh.sess %>%
  ggplot() +
  geom_point(aes(session, avg, fill = as.factor(subject)), shape = 21, size = 2) +
  #geom_smooth(method = 'lm', aes(session, avg)) + 
  
  facet_wrap( ~ subject, ncol = 4) +
  xlab("Session") +
  ylab("ER") +
  theme_classic() +
  scale_x_discrete(limits = seq(1,7,2)) +
  scale_y_continuous(limits = c(0,100)) +
  scale_color_manual(values = seqColor[c(1:4)]) +
  scale_fill_manual(values = seqColor[c(1:4)]) +
  figTheme +
  labs(
    title = "Extension Ratio Threshold",
    fill = "Participant"
  )
```

Using Spearman correlation
```{r ThresholdPearson, warning = FALSE}
print("Session correlation")
thresh.nestSess <-
  thresh.sess %>%
  #filter(subject > 1) %>%
  as_tibble() %>%
  group_by(subject) %>%
  nest()

thresh.nestSess %>%
  mutate(
    test = map(data,~cor.test(.x$session, .x$avg, method = "spearman", data = df)),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  select(c("subject", "estimate","p.value")) %>%
  dplyr::rename("Participant"=subject, "rho"=estimate, "p"=p.value) %>%
  pander()

```

## Averaged Activity
```{r AvgFlexExtInd}
#cast(subject~session~block~trial~group,value = "meanAmp")
#Averaged

rvt7c.data %>%
  # group_by(subject,allBlock,group) %>%
  # summarise(avg = mean(meanAmp)) %>%
  melt(id = c("subject","block")) %>%
  
  ggplot() + # meanAmp, meanNorm, medFreq
  geom_point(aes(block, value, fill = as.factor(subject)), shape = 21, size = 2) +
  #geom_smooth(method = 'lm', aes(block, value)) + 
  
  facet_wrap(variable ~ subject, ncol = 4, scales = "free") +
  xlab("Block") +
  ylab("Z score") +
  theme_classic() +
  #scale_x_discrete(limits = seq(1,7,2)) +
  scale_color_manual(values = seqColor[c(1:4)]) +
  scale_fill_manual(values = seqColor[c(1:4)]) +
  figTheme +
  labs(
    title = "Reinvent Activity",
    fill = "Participant"
  )


rvt7c.ses <- rvt7c.data
rvt7c.ses$session <- rep(rep(1:7, each = 6), times = 4)

rvt7c.avg <-
  rvt7c.ses %>%
  select(-c("block")) %>%
  melt(id = c("subject","session")) %>%
  group_by(subject,session,variable) %>%
  summarise(avg = mean(value))

rvt7c.avg %>%
  #select(-c("block")) %>%
  #melt(id = c("subject","session")) %>%
  ggplot() + # meanAmp, meanNorm, medFreq
  geom_point(aes(session, avg, fill = as.factor(subject)), shape = 21, size = 2) +
  geom_smooth(aes(session, avg), method = 'lm', se = FALSE) + 
  
  facet_wrap(variable ~ subject, ncol = 4, scales = "free_x") +
  xlab("Session") +
  ylab("Z score") +
  theme_classic() +
  scale_x_discrete(limits = seq(1,7,2)) +
  scale_y_continuous(limits = c(-2,6)) +
  scale_color_manual(values = seqColor[c(1:4)]) +
  scale_fill_manual(values = seqColor[c(1:4)]) +
  figTheme +
  labs(
    title = "Reinvent Activity",
    fill = "Participant"
  )

rvt.all <-
  rvt7c.avg %>%
  #filter(variable == "extensors") %>%
  dcast(subject + session ~ variable)
rvt.all$threshold <- thresh.sess$avg
rvt.all$success <- perf.sess$score

rvt.all$grip <-
  behav.data %>%
  filter(session %in% c(3:9)) %>%
  mutate(session = session - 2) %>%
  pull(GripMore)

rvt.all <- data.frame(rvt.all)

###### Final figures ###########


rvt.all %>%
  mutate(session = session+2) %>%
  select(-c("threshold","success","grip")) %>%
  melt(id = c("subject","session")) %>%
  ggplot() + # meanAmp, meanNorm, medFreq
  geom_point(aes(session, value, shape = as.factor(subject)), size = 2) +
  geom_smooth(aes(session, value), method = 'lm', se = FALSE) + 
  
  facet_wrap(variable ~ subject, nrow = 5, ncol = 4, scales = "fixed")+ #strip.position = "left") +
  xlab("Session") +
  ylab("Activity Z score") +
  theme_classic() +
  #scale_x_discrete(limits = seq(3,9,1)) +
  scale_y_continuous(limits = c(-2,6)) +
  scale_color_manual(values = seqColor[c(1:4)]) +
  scale_fill_manual(values = seqColor[c(1:4)]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  theme(
    strip.background.x = element_blank(),
    strip.text.x = element_blank()
  )+
  labs(
    title = "Reinvent Activity",
    shape = "Participant"
  )
ggsave("svg/rvtAct.svg", device = "svg", 
       width = 8,  height = 5,  units = "in",  dpi = 300)

rvt.all %>%
  mutate(session = session+2) %>%
  select(-c("extensors","flexors","individuation","grip")) %>%
  melt(id = c("subject","session")) %>%
  ggplot() + # meanAmp, meanNorm, medFreq
  geom_point(aes(session, value, shape = as.factor(subject)), size = 2) +
  geom_smooth(aes(session, value), method = 'lm', se = FALSE) + 
  
  facet_wrap(variable ~ subject, nrow = 5, ncol = 4, scales = "fixed" ) +
  xlab("Session") +
  ylab("% ER,  % Success") +
  theme_classic() +
  #scale_x_discrete(limits = seq(3,9,1)) +
  scale_y_continuous(limits = c(0,100)) +
  scale_color_manual(values = seqColor[c(1:4)]) +
  scale_fill_manual(values = seqColor[c(1:4)]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  theme(
    strip.background.x = element_blank(),
    strip.text.x = element_blank(),
    legend.text = element_blank()
  )+
  labs(
    title = "Reinvent Activity",
    shape = "Participant"
  )
ggsave("svg/rvtThr.svg", device = "svg", 
       width = 8,  height = 3,  units = "in",  dpi = 300)

rvt.all %>%
  mutate(session = session+2) %>%
  select(c("subject","session","grip")) %>%
  #melt(id = c("subject","session")) %>%
  ggplot() + # meanAmp, meanNorm, medFreq
  geom_point(aes(session, grip, shape = as.factor(subject)), size = 2) +
  geom_smooth(aes(session, grip), method = 'lm', se = FALSE) + 
  
  facet_wrap( ~ subject, nrow = 5, ncol = 4, scales = "fixed") +
  xlab("Session") +
  ylab("Grip (Kg)") +
  theme_classic() +
  #scale_x_discrete(limits = seq(3,9,1)) +
  #scale_y_continuous(limits = c(0,100)) +
  scale_color_manual(values = seqColor[c(1:4)]) +
  scale_fill_manual(values = seqColor[c(1:4)]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  theme(
    strip.background.x = element_blank(),
    strip.text.x = element_blank(),
    legend.text = element_blank()
  )+
  labs(
    title = "Reinvent Activity",
    shape = "Participant"
  )
ggsave("svg/rvtGrip.svg", device = "svg", 
       width = 8,  height = 2,  units = "in",  dpi = 300)



rvt.all %>%
  mutate(session = session+2) %>%
  select(c("subject","session","extensors","individuation","success")) %>%
  melt(id = c("subject","session")) %>%
  ggplot() + # meanAmp, meanNorm, medFreq
  geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)), size = 2) +
  geom_smooth(aes(session, value), method = 'lm', se = FALSE) + 
  
  facet_wrap(variable ~ subject, nrow = 5, ncol = 4) +
  xlab("") +
  ylab("") +
  theme_classic() +
  #scale_x_discrete(limits = seq(3,9,1)) +
  scale_y_continuous(limits = c(-2,6)) +
  scale_color_manual(values = seqColor[c(1:4)]) +
  scale_fill_manual(values = seqColor[c(1:4)]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  theme(
    strip.background.x = element_blank(),
    strip.text.x = element_blank(),
    legend.text = element_blank()
  )+
  labs(
    title = "Reinvent Activity",
    fill = "Participant",
    shape = "Participant"
  )
ggsave("svg/rvtECS1.svg", device = "svg", 
       width = 8,  height = 5,  units = "in",  dpi = 300)

rvt.all %>%
  mutate(session = session+2) %>%
  select(c("subject","session","extensors","individuation","success")) %>%
  melt(id = c("subject","session")) %>%
  ggplot() + # meanAmp, meanNorm, medFreq
  geom_point(aes(session, value, shape = as.factor(subject), fill = as.factor(subject)), size = 2) +
  geom_smooth(aes(session, value), method = 'lm', se = FALSE) + 
  
  facet_wrap(variable ~ subject, nrow = 5, ncol = 4) +
  xlab("") +
  ylab("") +
  theme_classic() +
  #scale_x_discrete(limits = seq(3,9,1)) +
  scale_y_continuous(limits = c(0,100)) +
  scale_color_manual(values = seqColor[c(1:4)]) +
  scale_fill_manual(values = seqColor[c(1:4)]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  theme(
    strip.background.x = element_blank(),
    strip.text.x = element_blank(),
    legend.text = element_blank()
  )+
  labs(
    title = "Reinvent Activity",
    fill = "Participant",
    shape = "Participant"
  )
ggsave("svg/rvtECS2.svg", device = "svg", 
       width = 8,  height = 5,  units = "in",  dpi = 300)
```




```{r ActivityCorrelation}
# Session correlation
rvt.nestSess <-
  rvt.all %>%
  as_tibble() %>%
  group_by(subject) %>%
  nest()

print("Extensors session correlation")
rvt.nestSess %>%
  mutate(
    test = map(data, ~cor.test(.x$session, .x$extensors, method = "spearman")),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  select(c("subject", "estimate","p.value")) %>%
  dplyr::rename("Participant"=subject, "rho"=estimate, "p"=p.value)%>%
  pander()

print("Flexors session correlation")
rvt.nestSess %>%
  mutate(
    test = map(data, ~cor.test(.x$session, .x$flexors, method = "spearman")),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  select(c("subject", "estimate","p.value")) %>%
  dplyr::rename("Participant"=subject, "rho"=estimate, "p"=p.value)%>%
  pander()

print("ER session correlation")
rvt.nestSess %>%
  mutate(
    test = map(data, ~cor.test(.x$session, .x$individuation, method = "spearman")),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  select(c("subject", "estimate","p.value")) %>%
  dplyr::rename("Participant"=subject, "rho"=estimate, "p"=p.value)%>%
  pander()

print("Threshold session correlation")
rvt.nestSess %>%
  mutate(
    test = map(data, ~cor.test(.x$session, .x$threshold, method = "spearman")),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  select(c("subject", "estimate","p.value")) %>%
  dplyr::rename("Participant"=subject, "rho"=estimate, "p"=p.value)%>%
  pander()

print("Performance session correlation")
rvt.nestSess %>%
  mutate(
    test = map(data, ~cor.test(.x$session, .x$success, method = "spearman")),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  select(c("subject", "estimate","p.value")) %>%
  dplyr::rename("Participant"=subject, "rho"=estimate, "p"=p.value)%>%
  pander()

print("Grip session correlation")
rvt.nestSess %>%
  mutate(
    test = map(data, ~cor.test(.x$session, .x$grip, method = "spearman")),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  select(c("subject", "estimate","p.value")) %>%
  dplyr::rename("Participant"=subject, "rho"=estimate, "p"=p.value)%>%
  pander()

# Group stats
aux = TRUE
for (scale in c("extensors","flexors","individuation","threshold","success","grip")) {
  
  pre <-
    rvt.all %>%
    filter(session == 1) %>%
    pull(scale)
  post <-
    rvt.all %>%
    filter(session == 7) %>%
    pull(scale)
  
  tt <- t.test(pre, post, paired = TRUE)
  
  if(aux){
    t <- data.frame(Activity = scale, t = tt$statistic, p = tt$p.value,
                    Pre = paste(formatC(mean(pre, na.rm = T),digits = 5)," (",formatC(sd(pre, na.rm = T),digits = 5),")",sep = ""),
                    Post = paste(formatC(mean(post, na.rm = T),digits = 5)," (",formatC(sd(post, na.rm = T),digits = 5),")",sep = ""))
    aux = FALSE
  }
  else{
    t <- bind_rows(t,data.frame(Activity = scale, t = tt$statistic, p = tt$p.value,
                                Pre = paste(formatC(mean(pre, na.rm = T),digits = 5)," (",formatC(sd(pre, na.rm = T),digits = 5),")",sep = ""),
                                Post = paste(formatC(mean(post, na.rm = T),digits = 5)," (",formatC(sd(post, na.rm = T),digits = 5),")",sep = "")))
  }
}

t %>%
  arrange(p) %>%
  pander()
```


## MVC Grip Change
```{r MVCgrip}
mvc7c.data %>%
  ggplot() + # meanAmp, meanNorm, medFreq
  geom_line(aes(session, mvcCci, color = as.factor(subject)), size = sz-8) +
  geom_point(aes(session, mvcCci, fill = as.factor(subject)), shape = 21, size = sz-5) +
  #geom_smooth(method = 'lm', aes(session, mvcCci)) + 
  
  facet_wrap(~ subject, ncol = 4) +
  xlab("Session") +
  ylab("Individuation") +
  theme_classic() +
  scale_x_discrete(limits = seq(1,7,2)) +
  scale_color_manual(values = seqColor[c(1:4)]) +
  scale_fill_manual(values = seqColor[c(1:4)]) +
  figTheme +
  labs(
    title = "MVC Individuation",
    fill = "Participant",
    color = "Participant"
  )

mvc7c.data %>%
  select(-c(mvcFlex,mvcExt,mvcCci)) %>%
  dplyr::rename(Flexors = mvcFlexFrac,
                Extensors = mvcExtFrac,
                Individuation = mvcCciFrac) %>%
  melt(id = c("subject","session")) %>%
  ggplot() + # meanAmp, meanNorm, medFreq
  geom_line(aes(session, value, color = as.factor(variable)), size = sz-8) +
  geom_point(aes(session, value, fill = as.factor(variable)), shape = 21, size = sz-6) +
  #geom_smooth(method = 'lm', aes(session, value)) + 
  
  facet_wrap(~ subject, ncol = 4, scales = "free_x") +
  xlab("Session") +
  ylab("Fractional Change") +
  theme_classic() +
  scale_x_discrete(limits = seq(1,7,2)) +
  scale_color_manual(values = catColor[c(1:4)]) +
  scale_fill_manual(values = catColor[c(1:4)]) +
  figTheme +
  labs(
    title = "MVC Activity",
    fill = "Activity",
    color = "Activity"
  )
ggsave("svg/mvc.svg", device = "svg")

behav.data %>%
  ggplot() +
  #geom_line(aes(session, grip, color = as.factor("Grip")), size = sz-6, alpha = 0.7) +
  geom_point(aes(session, GripMore, fill = as.factor("GripMore")), shape = 21, size = sz-5) +
  #geom_smooth(method = 'lm', aes(session, grip)) + 
  
  facet_wrap(~ subject, ncol = 4) +
  xlab("Session") +
  ylab("Kg") +
  theme_classic() +
  scale_x_discrete(limits = seq(2,10,2)) +
  scale_color_manual(values = divColor[4]) +
  scale_fill_manual(values = divColor[4]) +
  figTheme +
  labs(
    title = "Grip Strength",
    #subtitle = "Pre and post evaluation",
    #caption = "Preliminary data",
    fill = ""
  )
```


```{r MVCgripChange}
mvc7c.data %>%
  select(-c(mvcFlexFrac,mvcExtFrac,mvcCciFrac)) %>%
  dplyr::rename(Flexion = mvcFlex,
                Extension = mvcExt,
                Individuation = mvcCci) %>%
  filter(session %in% c(1,7)) %>%
  mutate(session = ifelse(session == 1, "Pre","Post")) %>%
  melt(id = c("subject","session")) %>%
  ggplot() + # meanAmp, meanNorm, medFreq
  geom_line(aes(as.factor(session), value, group = as.factor(subject), color = as.factor(subject)), size = sz-2, alpha = 0.7) +
  geom_point(aes(as.factor(session), value, shape = as.factor(subject), fill = as.factor(subject)),size = sz-1) +
  
  facet_wrap(~ variable, ncol = 4, scales = "free") +
  xlab("Session") +
  ylab("") +
  theme_classic() +
  scale_x_discrete(limits = c("Pre","Post")) +
  scale_color_manual(values = seqColor[1:5]) +
  scale_fill_manual(values = seqColor[1:5]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  labs(
    title = "MVC Activity",
    group = "Participant",
    fill = "Participant",
    shape = "Participant",
    color = "Participant"
  )

mvc7c.data %>%
  dplyr::rename(Flexion = mvcFlexFrac,
                Extension = mvcExtFrac,
                Individuation = mvcCciFrac) %>%
  select(-c(mvcFlex,mvcExt,mvcCci)) %>%
  filter(session %in% c(7)) %>%
  mutate(session = ifelse(session == 1, "Pre","Post")) %>%
  melt(id = c("subject","session")) %>%
  ggplot() + # meanAmp, meanNorm, medFreq
  geom_bar(aes(as.factor(session), value, fill = as.factor(subject)), size = sz-2,  stat = "identity", position = "dodge") +
  
  facet_wrap(~ variable, ncol = 4, scales = "free") +
  xlab("Session") +
  ylab("Ratio = (Post-Pre)/Pre") +
  theme_classic() +
  
  scale_color_manual(values = seqColor[1:5]) +
  scale_fill_manual(values = seqColor[1:5]) +
  scale_shape_manual(values = 21:24) +
  figTheme +
  labs(
    title = "MVC Activity Ratio",
    group = "Participant",
    fill = "Participant",
    shape = "Participant",
    color = "Participant"
  )


tmpMVCx <- mvc7c.data %>%
  select(-c(mvcFlexFrac,mvcExtFrac,mvcCciFrac)) %>%
  filter(session %in% c(1))
tmpMVCy <- mvc7c.data %>%
  select(-c(mvcFlexFrac,mvcExtFrac,mvcCciFrac)) %>%
  filter(session %in% c(7))

t.test(tmpMVCx$mvcFlex, tmpMVCy$mvcFlex, paired = TRUE)
t.test(tmpMVCx$mvcExt, tmpMVCy$mvcExt, paired = TRUE)
t.test(tmpMVCx$mvcCci, tmpMVCy$mvcCci, paired = TRUE)
```

```{r, eval=F}
mvc7c.nestTibble <-
  mvc7c.data %>%
  #filter(subject > 1) %>%
  as_tibble() %>%
  group_by(subject) %>%
  nest()

mvc7c.nestTibble %>%
  mutate(
    test = map(data,~cor.test(.x$session, .x$mvcCci, method = "spearman", data = df)),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  pander()

mvc7c.nestTibble %>%
  mutate(
    test = map(data,~cor.test(.x$session, .x$mvcFlexFrac, method = "spearman", data = df)),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  pander()

mvc7c.nestTibble %>%
  mutate(
    test = map(data,~cor.test(.x$session, .x$mvcExtFrac, method = "spearman", data = df)),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  pander()

mvc7c.nestTibble %>%
  mutate(
    test = map(data,~cor.test(.x$session, .x$mvcCciFrac, method = "spearman", data = df)),
    tidied = map(test,tidy)
  ) %>%
  unnest(tidied, .drop = TRUE) %>%
  pander()
```

***


